<% function formatDate(dateString){
  if (!dateString) return '-';
  const date = new Date(dateString);
  const day = String(date.getDate()).padStart(2,'0');
  const month = String(date.getMonth()+1).padStart(2,'0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

function formatNumberDisplay(value) {
  if (value === null || value === undefined || value === '') return '-';
  const num = parseFloat(value);
  if (isNaN(num)) return '-';
  if (num === 0) return '0';
  let result = '';
  if (Number.isInteger(num)) {
    result = num.toString();
  } else {
    const decimalStr = num.toString().split('.')[1];
    if (!decimalStr) {
      result = num.toString();
    } else if (decimalStr.length <= 2) {
      result = num.toString();
    } else {
      result = num.toFixed(3);
    }
  }
  if (num < 0) {
    return '\u200E' + result;
  }
  return result;
} %>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-file-earmark-text"></i> تفاصيل الطلبية <%= order.order_number %></h2>
        <div>
          <a href="/costs/orders/<%= order.id %>/print" target="_blank" class="btn btn-outline-primary me-2 no-print">
            <i class="bi bi-printer"></i> طباعة
          </a>
          <button id="exportOrderPdfBtn" class="btn btn-success me-2 no-print">
            <i class="bi bi-file-earmark-pdf"></i> تصدير PDF
          </button>
          <a href="/costs/orders" class="btn btn-outline-secondary no-print">
            <i class="bi bi-arrow-right me-1"></i> العودة للطلبيات
          </a>
        </div>
      </div>

      <!-- PDF Export Modal -->
      <div id="orderPdfExportModal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="bi bi-file-earmark-pdf me-2 text-success"></i> تم إنشاء ملف PDF</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body text-center">
              <div class="mb-3">
                <input type="text" id="orderPdfLinkInput" class="form-control text-center" readonly style="direction:ltr; font-size:0.95em;" />
              </div>
              <div class="d-flex justify-content-center gap-2 mb-2">
                <button id="copyOrderPdfLinkBtn" class="btn btn-outline-primary btn-sm"><i class="bi bi-clipboard me-1"></i> نسخ الرابط</button>
                <a id="openOrderPdfLinkBtn" class="btn btn-outline-info btn-sm" target="_blank"><i class="bi bi-box-arrow-up-right me-1"></i> فتح الرابط</a>
                <a id="whatsappOrderShareBtn" class="btn btn-outline-success btn-sm" target="_blank"><i class="bi bi-whatsapp me-1"></i> ارسال عبر واتساب</a>
              </div>
              <div class="alert alert-success py-2 mb-0">يمكنك مشاركة الرابط مع أي شخص لتحميل الطلبية مباشرة</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow mb-4">
        <div class="card-header">
          <h5 class="mb-0">معلومات الطلبية</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <td><strong>رقم الطلبية:</strong></td>
                  <td><%= order.order_number %></td>
                </tr>
                <tr>
                  <td><strong>اسم الزبون:</strong></td>
                  <td><%= order.client_name || '-' %></td>
                </tr>
                <tr>
                  <td><strong>تاريخ الطلبية:</strong></td>
                  <td><%= formatDate(order.order_date) %></td>
                </tr>
                <tr>
                  <td><strong>تاريخ التسليم:</strong></td>
                  <td><%= formatDate(order.delivery_date) %></td>
                </tr>
                <tr>
                  <td><strong>الحالة:</strong></td>
                  <td>
                    <span class="badge bg-<%= 
                      order.status === 'pending' ? 'warning' : 
                      order.status === 'processing' ? 'info' : 
                      order.status === 'completed' ? 'success' : 'danger' 
                    %>">
                      <%= 
                        order.status === 'pending' ? 'قيد الانتظار' :
                        order.status === 'processing' ? 'قيد المعالجة' :
                        order.status === 'completed' ? 'مكتمل' : 'ملغي'
                      %>
                    </span>
                  </td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <td><strong>المسؤول عن التجهيز:</strong></td>
                  <td><%= order.responsible_worker || '-' %></td>
                </tr>
                <tr>
                  <td><strong>مراقب الجودة:</strong></td>
                  <td><%= order.quality_controller || '-' %></td>
                </tr>
                <tr>
                  <td><strong>عدد الطبالي:</strong></td>
                  <td><%= order.pallets_count != null ? formatNumberDisplay(order.pallets_count) : '-' %></td>
                </tr>
                <tr>
                  <td><strong>رقم الحاوية:</strong></td>
                  <td><%= order.container_number || '-' %></td>
                </tr>
                <tr>
                  <td><strong>عدد الطرود:</strong></td>
                  <td><%= order.packages_count != null ? formatNumberDisplay(order.packages_count) : '-' %></td>
                </tr>
                <tr>
                  <td><strong>رقم البوليصة:</strong></td>
                  <td><%= order.waybill_number || '-' %></td>
                </tr>
                <tr>
                  <td><strong>رقم الاعتماد:</strong></td>
                  <td><%= order.accreditation_number || '-' %></td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow">
        <div class="card-header">
          <h5 class="mb-0">مواد الطلبية</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>رقم المادة</th>
                  <th>اسم المادة</th>
                  <th>الوحدة</th>
                  <th>الكمية المطلوبة</th>
                  <th>الوزن</th>
                  <th>الوزن الإجمالي</th>
                  <th>الحجم</th>
                  <th>سعر الطرد</th>
                  <th>السعر الإجمالي</th>
                  <th>ملاحظات</th>
                </tr>
              </thead>
              <tbody>
                <% (items || []).forEach((item) => { %>
                  <tr>
                    <td><%= item.material_id || '-' %></td>
                    <td><%= item.material_name || '-' %></td>
                    <td><%= item.unit || '-' %></td>
                    <td><%= item.requested_quantity != null ? formatNumberDisplay(item.requested_quantity) : '-' %></td>
                    <td><%= item.weight != null ? formatNumberDisplay(item.weight) : '-' %></td>
                    <td><%= item.weight_total != null ? formatNumberDisplay(item.weight_total) : '-' %></td>
                    <td><%= item.volume != null ? formatNumberDisplay(item.volume) : '-' %></td>
                    <td><%= (typeof item.unit_price !== 'undefined') ? formatNumberDisplay(item.unit_price) : '-' %> <%= (typeof defaultCurrency !== 'undefined' && defaultCurrency && defaultCurrency.symbol) ? defaultCurrency.symbol : '' %></td>
                    <td><%= (typeof item.total_price !== 'undefined') ? formatNumberDisplay(item.total_price) : '-' %> <%= (typeof defaultCurrency !== 'undefined' && defaultCurrency && defaultCurrency.symbol) ? defaultCurrency.symbol : '' %></td>
                    <td><%= item.notes || '-' %></td>
                  </tr>
                <% }) %>
              </tbody>
              <tfoot>
                <tr class="table-info">
                  <td colspan="3" class="text-center"><strong>الإجماليات</strong></td>
                  <td><strong><%= typeof totals !== 'undefined' && totals ? formatNumberDisplay(totals.totalRequestedQuantity) : '0' %></strong></td>
                  <td></td>
                  <td><strong><%= typeof totals !== 'undefined' && totals ? formatNumberDisplay(totals.totalWeight) : '0' %></strong></td>
                  <td><strong><%= typeof totals !== 'undefined' && totals ? formatNumberDisplay(totals.totalVolume) : '0' %></strong></td>
                  <td></td>
                  <td><strong><%= typeof totals !== 'undefined' && totals ? formatNumberDisplay(totals.grandTotal) : '0' %> <%= (typeof defaultCurrency !== 'undefined' && defaultCurrency && defaultCurrency.symbol) ? defaultCurrency.symbol : '' %></strong></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <% if (order.notes) { %>
      <div class="card shadow mt-4">
        <div class="card-header">
          <h5 class="mb-0">ملاحظات</h5>
        </div>
        <div class="card-body">
          <p><%= order.notes %></p>
        </div>
      </div>
      <% } %>
    </div>
  </div>
</div>

<script>
function formatDate(dateString){
  if (!dateString) return '-';
  const date = new Date(dateString);
  const day = String(date.getDate()).padStart(2,'0');
  const month = String(date.getMonth()+1).padStart(2,'0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}
</script>

<style>
@media print {
  .no-print { display: none !important; }
  .card { border: 1px solid #000 !important; box-shadow: none !important; }
  .card-header { background-color: #f8f9fa !important; border-bottom: 1px solid #000 !important; }
  body { font-size: 12px; }
  .table { font-size: 11px; }
  .table th, .table td { padding: 4px; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const exportBtn = document.getElementById('exportOrderPdfBtn');
  const modalElem = document.getElementById('orderPdfExportModal');
  const modal = modalElem ? new bootstrap.Modal(modalElem) : null;
  const linkInput = document.getElementById('orderPdfLinkInput');
  const copyBtn = document.getElementById('copyOrderPdfLinkBtn');
  const openBtn = document.getElementById('openOrderPdfLinkBtn');
  const waBtn = document.getElementById('whatsappOrderShareBtn');
  if (!exportBtn) return;
  exportBtn.addEventListener('click', async function(){
    exportBtn.disabled = true;
    exportBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> جاري التصدير...';
    try {
      const res = await fetch(`/costs/orders/<%= order.id %>/pdf`);
      const data = await res.json();
      if (data.success && data.url) {
        const link = data.url;
        if (linkInput) linkInput.value = link;
        if (openBtn) openBtn.href = link;
        if (waBtn) waBtn.href = `https://wa.me/?text=${encodeURIComponent(link)}`;
        if (modal) modal.show();
      } else {
        alert(data.message || 'حدث خطأ أثناء توليد ملف PDF');
      }
    } catch (e) {
      alert('حدث خطأ في الاتصال بالخادم');
    }
    exportBtn.disabled = false;
    exportBtn.innerHTML = '<i class="bi bi-file-earmark-pdf"></i> تصدير PDF';
  });
  if (copyBtn && linkInput) {
    copyBtn.addEventListener('click', function(){ linkInput.select(); document.execCommand('copy'); });
  }
});
</script>

