<% function fmtDate(d){ if(!d) return '-'; const dt=new Date(d); const dd=String(dt.getDate()).padStart(2,'0'); const mm=String(dt.getMonth()+1).padStart(2,'0'); const yy=dt.getFullYear(); return `${dd}/${mm}/${yy}`; }
function formatNumberDisplay(value) {
  if (value === null || value === undefined || value === '') return '-';
  const num = parseFloat(value);
  if (isNaN(num)) return '-';
  if (num === 0) return '0';
  let result = '';
  if (Number.isInteger(num)) result = num.toString();
  else {
    const ds = num.toString().split('.')[1];
    result = !ds ? num.toString() : ds.length <= 2 ? num.toString() : num.toFixed(3);
  }
  if (num < 0) return '\u200E' + result;
  return result;
}
const currencySymbol = (typeof defaultCurrency !== 'undefined' && defaultCurrency && defaultCurrency.symbol) ? defaultCurrency.symbol : '';
%>

<div class="container-fluid" style="direction: rtl; font-family: 'Cairo','Amiri',sans-serif;">
  <!-- Header -->
  <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
    <tr>
      <td style="text-align: right; font-weight: bold; line-height: 1.4; width: 37%; font-size: 10pt;">
        <div>مؤسسة عجاج أخوان التجارية</div>
        <div>لإنتاج وتعبئة المواد الغذائية</div>
        <div>وتجارة زيت الزيتون البكر</div>
        <div style="font-size: 12px;">س.ت 10369 – س.ص 10</div>
      </td>
      <td style="text-align: center; width: 26%;">
        <img src="/public/images/nexa.png" alt="شعار" style="width: 90px; height: 90px;">
      </td>
      <td style="text-align: left; font-weight: bold; line-height: 1.4; width: 37%; font-size: 10pt;">
        <div>Ajaj Brothers Commercial Foundation</div>
        <div>For Food Production and Packaging</div>
        <div>And Virgin Olive Oil Trade</div>
        <div style="font-size: 12px;">C.R. 10369 – I.R. 10</div>
      </td>
    </tr>
  </table>
  <hr>

  <!-- Title -->
  <div style="text-align:center; margin: 12px 0;">
    <div style="font-size: 13pt; font-weight: 700;">عرض سعر رقم (<%= quotation.quotation_number %>)</div>
  </div>

  <!-- Customer/Quotation Info -->
  <div class="info-stack">
    <div class="box-compact">
      <h6 class="section-title">بيانات العميل</h6>
      <div class="grid-kv">
        <div class="kv"><span>الاسم:</span><span><%= quotation.client_name || '-' %></span></div>
        <% if (quotation.client_phone) { %><div class="kv"><span>الهاتف:</span><span><%= quotation.client_phone %></span></div><% } %>
        <% if (quotation.client_address) { %><div class="kv full"><span>العنوان:</span><span><%= quotation.client_address %></span></div><% } %>
      </div>
    </div>
    <div class="box-compact">
      <h6 class="section-title">بيانات العرض</h6>
      <div class="grid-kv">
        <div class="kv"><span>التاريخ:</span><span><%= fmtDate(quotation.created_at) %></span></div>
        <div class="kv"><span>عدد المواد:</span><span><%= (items||[]).length %></span></div>
        <div class="kv"><span>إجمالي السعر:</span><span><%= `${formatNumberDisplay(grandTotal)} ${currencySymbol}` %></span></div>
      </div>
    </div>
    <% if (quotation.notes) { %>
      <div class="box-compact">
        <h6 class="section-title">ملاحظات</h6>
        <div class="notes"><%= quotation.notes %></div>
      </div>
    <% } %>
  </div>

  <!-- Items Table -->
  <div class="table-responsive" style="margin-top: 8px;">
    <table class="table-custom table-bordered text-center align-middle" style="font-size: 10pt; width: 100%;">
      <thead>
        <tr>
          <th style="width: 4%; padding: 6pt 4pt;">#</th>
          <th style="width: 26%; padding: 6pt 4pt;">اسم المادة</th>
          <th style="width: 10%; padding: 6pt 4pt;">وحدة التعبئة</th>
          <th style="width: 10%; padding: 6pt 4pt;">وزن التعبئة</th>
          <th style="width: 10%; padding: 6pt 4pt;">شد الكرتون</th>
          <th style="width: 12%; padding: 6pt 4pt;">السعر</th>
          <th style="width: 8%; padding: 6pt 4pt;">الكمية</th>
          <th style="width: 20%; padding: 6pt 4pt;">المجموع</th>
        </tr>
      </thead>
      <tbody>
        <% (items || []).forEach((item, idx) => { %>
          <tr>
            <td style="padding: 6pt 4pt;"><%= formatNumberDisplay(idx + 1) %></td>
            <td style="padding: 6pt 4pt; text-align: right;">
              <div><%= item.material_name || '-' %></div>
              <% if (item.material_type) { %><div style="color:#666; font-size:9pt;">(<%= item.material_type %>)</div><% } %>
            </td>
            <td style="padding: 6pt 4pt;"><%= item.packaging_unit || '-' %></td>
            <td style="padding: 6pt 4pt;"><%= item.packaging_weight != null ? formatNumberDisplay(item.packaging_weight) : '-' %></td>
            <td style="padding: 6pt 4pt;"><%= item.pieces_per_package != null ? formatNumberDisplay(item.pieces_per_package) : '-' %></td>
            <td style="padding: 6pt 4pt;"><%= `${formatNumberDisplay(item.final_price)} ${currencySymbol}` %></td>
            <td style="padding: 6pt 4pt;"><%= item.quantity != null ? formatNumberDisplay(item.quantity) : '-' %></td>
            <td style="padding: 6pt 4pt;"><%= `${formatNumberDisplay(item.total_price)} ${currencySymbol}` %></td>
          </tr>
        <% }) %>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="7" style="text-align: center; font-weight: 700;">الإجمالي</td>
          <td style="font-weight:700;"><%= `${formatNumberDisplay(grandTotal)} ${currencySymbol}` %></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Footer -->
  <div class="print-footer" id="fixed-print-footer" style="text-align:center; font-size: 9pt; margin-top: 10px;">
    <hr style="margin: 4px 0; border: 0.5px solid #bbb;">
    سوريا، حماة، أوتستراد دمشق-حلب الدولي، س.ت 10369 – س.ص 10<br>
    0940500511 – 0988111127 | ajajbrothers@gmail.com<br>
    جميع الحقوق محفوظة © <%= new Date().getFullYear() %> نظام إدارة المختبر | تم التطوير بواسطة شركة NEXA GROUP COMPANY
  </div>
</div>

<script>
  window.addEventListener('load', function(){ setTimeout(function(){ window.print(); }, 200); });
  function closeAfterPrint(){ setTimeout(function(){ try{ window.close(); }catch(e){} }, 100); }
  if ('onafterprint' in window) { window.addEventListener('afterprint', closeAfterPrint); }
  var mql = window.matchMedia && window.matchMedia('print');
  if (mql) {
    if (mql.addEventListener) { mql.addEventListener('change', function(e){ if(!e.matches) closeAfterPrint(); }); }
    else if (mql.addListener) { mql.addListener(function(e){ if(!e.matches) closeAfterPrint(); }); }
  }
</script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Amiri:wght@400;500;600;700&display=swap');
  @page { size: A4 portrait; margin: 1cm; }
  html, body { background: #fff !important; margin:0; padding:0; direction: rtl; text-align: right; font-family: 'Cairo','Amiri','Noto Naskh Arabic',sans-serif !important; font-size: 10pt; }
  .table-custom { width: 100%; border-collapse: separate; border-spacing: 0; }
  .table-custom th, .table-custom td { border: 1px solid #444; padding: 6pt 4pt; }
  .table-custom th { background: #f5f5f5; font-weight: 700; }
  thead { display: table-header-group; }
  tfoot { display: table-footer-group; }
  tr { page-break-inside: avoid; }
  .table-responsive { overflow-x: visible; }
  .info-stack { display: flex; flex-direction: column; gap: 6px; }
  .box-compact { border: 1px solid #ccc; padding: 6pt; border-radius: 4px; }
  .section-title { font-size: 11pt; font-weight: 700; margin: 0 0 4pt 0; }
  .grid-kv { display: grid; grid-template-columns: 1fr 1fr; gap: 2pt 8pt; }
  .kv { display: grid; grid-template-columns: auto 1fr; column-gap: 8pt; border-bottom: 1px dashed #e0e0e0; padding: 2pt 0; align-items: start; }
  .kv.full { grid-column: 1 / -1; }
  .kv span:first-child { color: #333; font-weight: 600; margin-left: 8px; }
  .kv span:last-child { white-space: normal; word-break: break-word; }
  .notes { white-space: pre-wrap; line-height: 1.6; }
  .container-fluid { padding-bottom: 80px; }
  .print-footer { position: fixed; left: 0; right: 0; bottom: 0; background: #fff; }
  .table-custom th, .table-custom td { padding: 4pt 3pt; }
</style>

