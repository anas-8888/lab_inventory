<% contentFor('style', function() { %>
<style>
    .activity-badge {
        font-size: 0.85rem;
    }
    .status-success { background-color: #28a745; }
    .status-error { background-color: #dc3545; }
    .status-warning { background-color: #ffc107; color: #212529; }
    .table-responsive {
        border-radius: 0.5rem;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    .filter-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .stats-card {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
    }
    .activity-row:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
    .time-ago {
        font-size: 0.85rem;
        color: #6c757d;
    }
    .method-badge {
        font-size: 0.75rem;
        min-width: 60px;
    }
    .pagination-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }
    .results-info {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    /* Animation للزر المتحرك */
    .spin {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* تحسين زر التحديث */
    #refreshBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
<% }); %>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- العنوان والإحصائيات -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1"><i class="bi bi-clock-history"></i> سجل الحركات</h2>
                    <p class="text-muted mb-0">آخر 500 حركة في النظام</p>
                </div>
                <div class="d-flex gap-2">
                    <!-- زر تحديث مباشر -->
                    <a href="/activity-logs" class="btn btn-outline-info">
                        <i class="bi bi-arrow-clockwise"></i> تحديث
                    </a>
                    <a href="/activity-logs/export" class="btn btn-success">
                        <i class="bi bi-download"></i> تصدير CSV
                    </a>
                </div>
            </div>

            
            <!-- بطاقة الفلاتر -->
            <div class="card filter-card mb-4">
                <div class="card-body">
                    <form method="GET" action="/activity-logs" id="filtersForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">بحث عام</label>
                                <input type="text" class="form-control" name="search" value="<%= filters.search %>" 
                                       placeholder="البحث في الحركات، المستخدمين، المسارات...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">المستخدم</label>
                                <select class="form-select" name="actor">
                                    <option value="">جميع المستخدمين</option>
                                    <% users.forEach(user => { %>
                                        <option value="<%= user.actor_name_snapshot %>" 
                                                <%= filters.actor === user.actor_name_snapshot ? 'selected' : '' %>>
                                            <%= user.actor_name_snapshot %>
                                        </option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">نوع الحركة</label>
                                <select class="form-select" name="action">
                                    <option value="">جميع الحركات</option>
                                    <% actions.forEach(action => { %>
                                        <option value="<%= action.action_name %>" 
                                                <%= filters.action === action.action_name ? 'selected' : '' %>>
                                            <%= action.action_name %>
                                        </option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">النتيجة</label>
                                <select class="form-select" name="status">
                                    <option value="">جميع النتائج</option>
                                    <option value="success" <%= filters.status === 'success' ? 'selected' : '' %>>نجاح</option>
                                    <option value="error" <%= filters.status === 'error' ? 'selected' : '' %>>فشل</option>
                                    <option value="redirect" <%= filters.status === 'redirect' ? 'selected' : '' %>>إعادة توجيه</option>
                                </select>
                            </div>
                            <div class="col-md-1.5">
                                <label class="form-label">من تاريخ</label>
                                <input type="date" class="form-control" name="date_from" value="<%= filters.date_from %>">
                            </div>
                            <div class="col-md-1.5">
                                <label class="form-label">إلى تاريخ</label>
                                <input type="date" class="form-control" name="date_to" value="<%= filters.date_to %>">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> تطبيق الفلاتر
                                </button>
                                <a href="/activity-logs" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> مسح الفلاتر
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- جدول السجلات -->
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th width="25%">الحركة</th>
                                    <th width="15%">المنفذ</th>
                                    <th width="10%">نوع العملية</th>
                                    <th width="20%">المسار</th>
                                    <th width="8%">النتيجة</th>
                                    <th width="12%">عنوان IP</th>
                                    <th width="10%">التوقيت</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (logs.length > 0) { %>
                                    <% logs.forEach(log => { %>
                                        <tr class="activity-row" data-log-id="<%= log.id %>">
                                            <td>
                                                <div class="fw-bold text-primary"><%= log.action_name %></div>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">
                                                    <%= log.actor_name_snapshot || 'النظام' %>
                                                </span>
                                            </td>
                                            <td>
                                                <% 
                                                let methodText = 'عملية';
                                                let methodClass = 'bg-secondary';
                                                switch(log.method) {
                                                    case 'GET':
                                                        methodText = 'قراءة';
                                                        methodClass = 'bg-info';
                                                        break;
                                                    case 'POST':
                                                        methodText = 'إضافة';
                                                        methodClass = 'bg-success';
                                                        break;
                                                    case 'PUT':
                                                        methodText = 'تعديل';
                                                        methodClass = 'bg-warning text-dark';
                                                        break;
                                                    case 'DELETE':
                                                        methodText = 'حذف';
                                                        methodClass = 'bg-danger';
                                                        break;
                                                    case 'PATCH':
                                                        methodText = 'تحديث';
                                                        methodClass = 'bg-primary';
                                                        break;
                                                }
                                                %>
                                                <span class="badge method-badge <%= methodClass %>">
                                                    <%= methodText %>
                                                </span>
                                            </td>
                                            <td>
                                                <code class="text-muted"><%= log.path %></code>
                                            </td>
                                            <td>
                                                <% 
                                                let statusText = 'غير معروف';
                                                let statusClass = 'bg-secondary';
                                                if (log.status_code >= 200 && log.status_code < 300) {
                                                    statusText = 'نجاح';
                                                    statusClass = 'bg-success';
                                                } else if (log.status_code >= 300 && log.status_code < 400) {
                                                    statusText = 'إعادة توجيه';
                                                    statusClass = 'bg-warning text-dark';
                                                } else if (log.status_code >= 400 && log.status_code < 500) {
                                                    statusText = 'خطأ عميل';
                                                    statusClass = 'bg-danger';
                                                } else if (log.status_code >= 500) {
                                                    statusText = 'خطأ خادم';
                                                    statusClass = 'bg-dark';
                                                } else if (!log.status_code) {
                                                    statusText = 'غير محدد';
                                                    statusClass = 'bg-secondary';
                                                }
                                                %>
                                                <span class="badge <%= statusClass %>" title="كود الحالة: <%= log.status_code || 'غير محدد' %>">
                                                    <%= statusText %>
                                                </span>
                                            </td>
                                            <td>
                                                <small class="text-muted"><%= log.ip_address || '-' %></small>
                                            </td>
                                            <td>
                                                <div class="text-nowrap">
                                                    <%= new Date(log.created_at).toLocaleString('ar-EG', { 
                                                        year: 'numeric', month: '2-digit', day: '2-digit',
                                                        hour: '2-digit', minute: '2-digit'
                                                    }) %>
                                                </div>
                                                <div class="time-ago" data-time="<%= log.created_at %>"></div>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <i class="bi bi-inbox display-4 text-muted"></i>
                                            <p class="text-muted mt-2">لا توجد سجلات تطابق معايير البحث</p>
                                        </td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- التنقل بين الصفحات -->
            <% if (pagination.total > 1) { %>
                <div class="pagination-wrapper">
                    <div class="results-info">
                        عرض <%= (pagination.current - 1) * pagination.limit + 1 %> - 
                        <%= Math.min(pagination.current * pagination.limit, pagination.totalRecords) %> 
                        من أصل <%= pagination.totalRecords %> سجل
                    </div>
                    <nav aria-label="تنقل الصفحات">
                        <ul class="pagination mb-0">
                            <% if (pagination.current > 1) { %>
                                <li class="page-item">
                                    <a class="page-link" href="?page=<%= pagination.current - 1 %><%= Object.keys(filters).map(key => filters[key] ? `&${key}=${encodeURIComponent(filters[key])}` : '').join('') %>">
                                        السابق
                                    </a>
                                </li>
                            <% } %>
                            
                            <% for (let i = Math.max(1, pagination.current - 2); i <= Math.min(pagination.total, pagination.current + 2); i++) { %>
                                <li class="page-item <%= i === pagination.current ? 'active' : '' %>">
                                    <a class="page-link" href="?page=<%= i %><%= Object.keys(filters).map(key => filters[key] ? `&${key}=${encodeURIComponent(filters[key])}` : '').join('') %>">
                                        <%= i %>
                                    </a>
                                </li>
                            <% } %>
                            
                            <% if (pagination.current < pagination.total) { %>
                                <li class="page-item">
                                    <a class="page-link" href="?page=<%= pagination.current + 1 %><%= Object.keys(filters).map(key => filters[key] ? `&${key}=${encodeURIComponent(filters[key])}` : '').join('') %>">
                                        التالي
                                    </a>
                                </li>
                            <% } %>
                        </ul>
                    </nav>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Modal تفاصيل السجل -->
<div class="modal fade" id="logDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تفاصيل السجل</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="logDetailsContent">
                <!-- سيتم ملؤها بـ JavaScript -->
            </div>
        </div>
    </div>
</div>

<% contentFor('script', function() { %>
<script>
// دالة بسيطة لتحديث الصفحة
function refreshPage() {
    
    // جرب عدة طرق للتأكد من التحديث
    try {
        // الطريقة الأولى
        window.location.reload();
    } catch (e) {
        try {
            // الطريقة الثانية
            window.location.href = window.location.href;
        } catch (e2) {
            // الطريقة الثالثة
            window.location = '/activity-logs';
        }
    }
}

// تحديث الوقت النسبي
function updateTimeAgo() {
    document.querySelectorAll('.time-ago').forEach(element => {
        const time = new Date(element.dataset.time);
        const now = new Date();
        const diff = now - time;
        
        if (diff < 60000) {
            element.textContent = 'منذ لحظات';
        } else if (diff < 3600000) {
            element.textContent = `منذ ${Math.floor(diff / 60000)} دقيقة`;
        } else if (diff < 86400000) {
            element.textContent = `منذ ${Math.floor(diff / 3600000)} ساعة`;
        } else {
            element.textContent = `منذ ${Math.floor(diff / 86400000)} يوم`;
        }
    });
}

// تحديث الإحصائيات
async function loadStats() {
    try {
        const response = await fetch('/activity-logs/api/stats');
        const data = await response.json();
        
        document.getElementById('uniqueUsers').textContent = data.stats.unique_users;
        document.getElementById('successfulRequests').textContent = data.stats.successful_requests;
        document.getElementById('failedRequests').textContent = data.stats.failed_requests;
    } catch (error) {
        console.error('خطأ في جلب الإحصائيات:', error);
    }
}

// عرض تفاصيل السجل
async function showLogDetails(logId) {
    try {
        const response = await fetch(`/activity-logs/details/${logId}`);
        const log = await response.json();
        
        // تحويل method إلى عربي
        let methodText = 'عملية';
        switch(log.method) {
            case 'GET': methodText = 'قراءة'; break;
            case 'POST': methodText = 'إضافة'; break;
            case 'PUT': methodText = 'تعديل'; break;
            case 'DELETE': methodText = 'حذف'; break;
            case 'PATCH': methodText = 'تحديث'; break;
        }
        
        // تحويل status إلى عربي
        let statusText = 'غير معروف';
        let statusClass = 'bg-secondary';
        if (log.status_code >= 200 && log.status_code < 300) {
            statusText = 'نجاح';
            statusClass = 'bg-success';
        } else if (log.status_code >= 300 && log.status_code < 400) {
            statusText = 'إعادة توجيه';
            statusClass = 'bg-warning text-dark';
        } else if (log.status_code >= 400 && log.status_code < 500) {
            statusText = 'خطأ عميل';
            statusClass = 'bg-danger';
        } else if (log.status_code >= 500) {
            statusText = 'خطأ خادم';
            statusClass = 'bg-dark';
        }

        const content = `
            <div class="row">
                <div class="col-md-6">
                    <strong>الحركة:</strong><br>
                    <span class="text-primary">${log.action_name}</span>
                </div>
                <div class="col-md-6">
                    <strong>المنفذ:</strong><br>
                    <span class="badge bg-secondary">${log.actor_name_snapshot || 'النظام'}</span>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-3">
                    <strong>نوع العملية:</strong><br>
                    <span class="badge bg-info">${methodText}</span>
                </div>
                <div class="col-md-3">
                    <strong>النتيجة:</strong><br>
                    <span class="badge ${statusClass}" title="كود: ${log.status_code || 'غير محدد'}">${statusText}</span>
                </div>
                <div class="col-md-6">
                    <strong>عنوان IP:</strong><br>
                    <code>${log.ip_address || '-'}</code>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <strong>المسار:</strong><br>
                    <code class="text-break">${log.path}</code>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <strong>معلومات المتصفح:</strong><br>
                    <small class="text-muted text-break">${log.user_agent || '-'}</small>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <strong>التوقيت:</strong><br>
                    ${new Date(log.created_at).toLocaleString('ar-EG')}
                </div>
            </div>
        `;
        
        document.getElementById('logDetailsContent').innerHTML = content;
        new bootstrap.Modal(document.getElementById('logDetailsModal')).show();
    } catch (error) {
        console.error('خطأ في جلب تفاصيل السجل:', error);
        alert('حدث خطأ أثناء جلب التفاصيل');
    }
}

// الأحداث
document.addEventListener('DOMContentLoaded', function() {
    // تحديث الوقت النسبي كل دقيقة
    updateTimeAgo();
    setInterval(updateTimeAgo, 60000);
    
    // تحميل الإحصائيات
    loadStats();
    
    // النقر على صف السجل لعرض التفاصيل
    document.querySelectorAll('.activity-row').forEach(row => {
        row.addEventListener('click', function() {
            const logId = this.dataset.logId;
            showLogDetails(logId);
        });
    });
    
    // زر التحديث
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            
            // إضافة حالة التحميل
            const btn = this;
            const originalContent = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> جاري التحديث...';
            
            // إعادة تحميل الصفحة - طريقة مبسطة
            setTimeout(() => {
                window.location.reload();
            }, 500);
            
            // في حالة فشل reload، استخدم href كبديل
            setTimeout(() => {
                if (!document.hidden) {
                    window.location.href = window.location.href.split('?')[0];
                }
            }, 2000);
        });
    } else {
        console.error('زر التحديث غير موجود في DOM');
    }
    
    // تطبيق الفلاتر عند تغيير القيم
    document.querySelectorAll('#filtersForm select, #filtersForm input[type="date"]').forEach(element => {
        element.addEventListener('change', function() {
            document.getElementById('filtersForm').submit();
        });
    });
});
</script>
<% }); %>
